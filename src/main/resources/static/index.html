<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>CoffeeLab - –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</title>
    <style>
        /* ========== –°–¢–ò–õ–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥) ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9eef5 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .app-header {
            margin-bottom: 30px;
        }

        .app-header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .app-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .role-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .role-btn {
            flex: 1;
            min-width: 200px;
            padding: 25px 20px;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .role-btn.client {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .role-btn.barista {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .role-btn.admin {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .role-btn.active {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            border: 4px solid white;
        }

        .role-btn:hover {
            transform: translateY(-5px);
        }

        .role-panel {
            display: none;
            animation: fadeIn 0.5s;
        }

        .role-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border: 2px solid rgba(255,255,255,0.5);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .card-header i {
            font-size: 2.2rem;
        }

        .card.client-card {
            border-top: 10px solid #2ecc71;
        }

        .card.barista-card {
            border-top: 10px solid #f39c12;
        }

        .card.admin-card {
            border-top: 10px solid #9b59b6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #34495e;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 18px 20px;
            font-size: 1.2rem;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            transition: border 0.3s;
            background: #f8f9fa;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #3498db;
            outline: none;
            background: white;
        }

        .action-btn {
            width: 100%;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            background: #3498db;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }

        .action-btn:hover {
            background: #2980b9;
            transform: translateY(-3px);
        }

        .action-btn.secondary {
            background: #95a5a6;
            box-shadow: 0 5px 15px rgba(149,165,166,0.3);
        }

        .action-btn.success {
            background: #27ae60;
            box-shadow: 0 5px 15px rgba(39,174,96,0.3);
        }

        .action-btn.warning {
            background: #f39c12;
            box-shadow: 0 5px 15px rgba(243,156,18,0.3);
        }

        .action-btn.danger {
            background: #e74c3c;
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .product-tile {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px 15px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .product-tile:hover {
            transform: translateY(-5px);
            border-color: #3498db;
            box-shadow: 0 10px 25px rgba(52,152,219,0.2);
        }

        .product-tile.selected {
            border-color: #2ecc71;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
        }

        .product-name {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .product-price {
            font-size: 1.5rem;
            color: #27ae60;
            font-weight: bold;
        }

        .product-desc {
            font-size: 1rem;
            color: #7f8c8d;
            margin-top: 8px;
        }

        .category-pills {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .category-pill {
            padding: 15px 35px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 50px;
            background: #f8f9fa;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 10px rgba(0,0,0,0.05);
        }

        .category-pill.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .category-pill.coffee { background: #f39c12; color: white; }
        .category-pill.tea { background: #27ae60; color: white; }
        .category-pill.dessert { background: #e74c3c; color: white; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.1rem;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 20px 15px;
            text-align: left;
            font-weight: bold;
            border-bottom: 3px solid #dee2e6;
        }

        .data-table td {
            padding: 20px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
        }

        .badge.success { background: #d4edda; color: #155724; }
        .badge.warning { background: #fff3cd; color: #856404; }
        .badge.danger { background: #f8d7da; color: #721c24; }

        .balance-info {
            background: linear-gradient(135deg, #f6f9fc, #e9f2f9);
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 20px 0;
            font-size: 1.4rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .final-total {
            font-size: 2.2rem;
            font-weight: bold;
            color: #27ae60;
            text-align: right;
            margin-top: 20px;
        }

        .mini-cart {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed #dee2e6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 100px auto;
            padding: 40px;
            max-width: 600px;
            border-radius: 30px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .role-btn {
                min-width: 100%;
                padding: 20px;
                font-size: 1.3rem;
            }

            .card-header {
                font-size: 1.5rem;
            }

            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <div class="app-header">
        <h1>‚òï CoffeeLab</h1>
        <p>–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ ‚Ä¢ –ë–æ–Ω—É—Å—ã 1‚ÇΩ = 1 –±–∞–ª–ª ‚Ä¢ –ö—ç—à–±—ç–∫ 5%</p>
    </div>

    <div class="role-nav">
        <button class="role-btn client" onclick="switchRole('client')">üë§ –ö–õ–ò–ï–ù–¢</button>
        <button class="role-btn barista" onclick="switchRole('barista')">üë®‚Äçüç≥ –ë–ê–†–ò–°–¢–ê</button>
        <button class="role-btn admin" onclick="switchRole('admin')">üëë –ê–î–ú–ò–ù</button>
    </div>

    <!-- ========== –ü–ê–ù–ï–õ–¨ –ö–õ–ò–ï–ù–¢–ê ========== -->
    <div id="client-panel" class="role-panel active">
        <div class="dashboard-grid">
            <div class="card client-card">
                <div class="card-header">
                    <span>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
                </div>
                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                    <input type="text" id="reg-phone" value="+79991112233" placeholder="+7 (999) 111-22-33">
                </div>
                <div class="form-group">
                    <label>–ò–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <input type="text" id="reg-name" placeholder="–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?">
                </div>
                <button class="action-btn success" onclick="registerClient()">
                    üéÅ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (+50 –±–æ–Ω—É—Å–æ–≤)
                </button>
            </div>

            <div class="card client-card">
                <div class="card-header">
                    <span>üí∞ –ë–∞–ª–∞–Ω—Å</span>
                </div>
                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞:</label>
                    <input type="text" id="balance-phone" value="+79991112233">
                </div>
                <button class="action-btn" onclick="findClient()">
                    üîç –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
                </button>
                <div class="balance-info" id="balance-display" style="display: none;">
                    <div>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:</div>
                    <div class="balance-amount" id="balance-amount">0</div>
                    <div style="font-size:1.2rem; color:#7f8c8d;">1 –±–æ–Ω—É—Å = 1 —Ä—É–±–ª—å</div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card client-card">
                <div class="card-header">
                    <span>üìä –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</span>
                </div>
                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞:</label>
                    <input type="text" id="history-phone" value="+79991112233">
                </div>
                <button class="action-btn secondary" onclick="loadBonusHistory()">
                    üìú –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                </button>
                <div id="history-table" style="margin-top:20px; max-height:400px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <!-- ========== –ü–ê–ù–ï–õ–¨ –ë–ê–†–ò–°–¢–´ ========== -->
    <div id="barista-panel" class="role-panel">
        <div class="dashboard-grid">
            <div class="card barista-card">
                <div class="card-header">
                    <span>üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                </div>
                <div class="category-pills" id="category-pills">
                    <div class="category-pill coffee active" onclick="filterProducts('all')">üìå –í—Å–µ</div>
                    <div class="category-pill coffee" onclick="filterProducts('–ö–æ—Ñ–µ')">‚òï –ö–æ—Ñ–µ</div>
                    <div class="category-pill tea" onclick="filterProducts('–ß–∞–π')">üçµ –ß–∞–π</div>
                    <div class="category-pill dessert" onclick="filterProducts('–î–µ—Å–µ—Ä—Ç—ã')">üç∞ –î–µ—Å–µ—Ä—Ç—ã</div>
                </div>

                <div class="products-grid" id="products-grid">
                    <!-- –¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ API -->
                </div>
            </div>

            <div class="card barista-card">
                <div class="card-header">
                    <span>üõí –¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑</span>
                </div>

                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</label>
                    <input type="text" id="current-order-id" value="" readonly>
                </div>

                <div class="balance-info" style="padding:20px;">
                    <div style="font-weight:bold; margin-bottom:15px;">üë§ –ö–ª–∏–µ–Ω—Ç:</div>
                    <div id="order-client">–ù–µ –≤—ã–±—Ä–∞–Ω</div>
                    <div id="order-client-balance" style="color:#27ae60;"></div>
                    <button class="action-btn secondary" style="margin-top:15px;" onclick="showClientSearch()">
                        üîç –ù–∞–π—Ç–∏/—Å–º–µ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                    </button>
                </div>

                <div class="mini-cart" id="mini-cart">
                    <!-- –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>

                <div class="totals-row">
                    <span>Subtotal:</span>
                    <span id="cart-subtotal">0‚ÇΩ</span>
                </div>
                <div class="totals-row">
                    <span>–ë–æ–Ω—É—Å—ã –∫ —Å–ø–∏—Å–∞–Ω–∏—é:</span>
                    <span>
                            <input type="number" id="bonus-to-spend" value="0" min="0" style="width:100px; padding:10px;">
                        </span>
                </div>
                <div class="totals-row" style="color:#e67e22;">
                    <span>–õ–∏–º–∏—Ç 30%:</span>
                    <span id="bonus-limit">0‚ÇΩ</span>
                </div>
                <div class="final-total" id="cart-total">
                    0‚ÇΩ
                </div>

                <button class="action-btn warning" onclick="createNewOrder()">
                    ‚ûï –ù–æ–≤—ã–π –∑–∞–∫–∞–∑
                </button>
                <button class="action-btn" onclick="showAddItemModal()">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                </button>
                <button class="action-btn success" onclick="spendBonuses()">
                    üí∞ –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å—ã
                </button>
                <button class="action-btn danger" onclick="completeOrder()">
                    ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑ (+5% –∫—ç—à–±—ç–∫)
                </button>
            </div>
        </div>
    </div>

    <!-- ========== –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ê ========== -->
    <div id="admin-panel" class="role-panel">
        <div class="dashboard-grid">
            <div class="card admin-card">
                <div class="card-header">
                    <span>üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é</span>
                </div>
                <div class="form-group">
                    <label>–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</label>
                    <select id="admin-category-filter" onchange="filterAdminProducts()">
                        <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        <option value="–ö–æ—Ñ–µ">–ö–æ—Ñ–µ</option>
                        <option value="–ß–∞–π">–ß–∞–π</option>
                        <option value="–î–µ—Å–µ—Ä—Ç—ã">–î–µ—Å–µ—Ä—Ç—ã</option>
                    </select>
                </div>

                <div style="margin-top:20px; max-height:400px; overflow-y:auto;">
                    <table class="data-table" id="products-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                        </tr>
                        </thead>
                        <tbody id="products-table-body">
                        <!-- –î–∞–Ω–Ω—ã–µ –∏–∑ API -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card admin-card">
                <div class="card-header">
                    <span>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                </div>

                <button class="action-btn" onclick="loadAdminStats()">
                    üìà –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                </button>

                <div class="balance-info" style="margin-top:20px;" id="stats-display">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card admin-card">
                <div class="card-header">
                    <span>üì¶ –í—Å–µ –∑–∞–∫–∞–∑—ã</span>
                </div>
                <div style="max-height:500px; overflow-y:auto;">
                    <table class="data-table" id="orders-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ö–ª–∏–µ–Ω—Ç</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                        </thead>
                        <tbody id="orders-table-body">
                        <!-- –î–∞–Ω–Ω—ã–µ –∏–∑ API -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card admin-card">
                <div class="card-header">
                    <span>üë• –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</span>
                </div>
                <div style="max-height:500px; overflow-y:auto;" id="clients-list">
                    <!-- –ö–ª–∏–µ–Ω—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ -->
    <div id="client-search-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px;">üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞</h2>
            <div class="form-group">
                <input type="text" id="search-phone" placeholder="+7 (999) 111-22-33" value="+79991112233">
            </div>
            <button class="action-btn" onclick="searchClient()">–ù–∞–π—Ç–∏</button>
            <button class="action-btn secondary" onclick="registerNewClient()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–≥–æ (+50)</button>
            <button class="action-btn secondary" onclick="hideClientSearch()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
    <div id="add-item-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
            <div class="form-group">
                <label>–¢–æ–≤–∞—Ä:</label>
                <select id="add-product-select" style="width:100%; padding:15px;">
                    <!-- –¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ API -->
                </select>
            </div>
            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                <input type="number" id="add-product-qty" value="1" min="1" style="width:100%; padding:15px;">
            </div>
            <button class="action-btn" onclick="addItemToOrder()">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="action-btn secondary" onclick="hideAddItemModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã API -->
    <div style="margin-top:30px; background: #2d3436; color: #dfe6e9; padding:20px; border-radius:15px; font-family: monospace;">
        <div style="display: flex; justify-content: space-between;">
            <span>üì° API Response:</span>
            <button onclick="clearResponse()" style="background: none; border: 1px solid #dfe6e9; color: #dfe6e9; padding:5px 15px; border-radius:5px; cursor:pointer;">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <pre id="api-response" style="margin-top:15px; white-space: pre-wrap; max-height:300px; overflow-y:auto;">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...</pre>
    </div>
</div>

<script>
    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    let currentOrderId = null;
    let currentClient = null;
    let currentOrder = null;
    let products = [];

    // ========== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–´–ó–û–í–ê API ==========
    async function apiCall(url, method = 'GET', body = null) {
        try {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(url, options);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
            }

            document.getElementById('api-response').innerText = JSON.stringify(data, null, 2);
            return data;
        } catch (error) {
            document.getElementById('api-response').innerText = '–û—à–∏–±–∫–∞: ' + error;
            return null;
        }
    }

    function clearResponse() {
        document.getElementById('api-response').innerText = '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...';
    }

    // ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –†–û–õ–ï–ô ==========
    function switchRole(role) {
        document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        document.querySelectorAll('.role-panel').forEach(panel => panel.classList.remove('active'));
        document.getElementById(role + '-panel').classList.add('active');

        if (role === 'barista') {
            loadProductsForBarista();
        } else if (role === 'admin') {
            loadAdminProducts();
            loadAllOrders();
            loadAllClients();
        }
    }

    // ========== –ö–õ–ò–ï–ù–¢ ==========
    async function registerClient() {
        const phone = document.getElementById('reg-phone').value;
        const name = document.getElementById('reg-name').value || '–ö–ª–∏–µ–Ω—Ç';

        const data = await apiCall('/api/clients/register', 'POST', {
            phone: phone,
            fullName: name
        });

        if (data) {
            alert('–ö–ª–∏–µ–Ω—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω! –ë–æ–Ω—É—Å–æ–≤: ' + data.bonusBalance);
            document.getElementById('balance-display').style.display = 'block';
            document.getElementById('balance-amount').innerText = data.bonusBalance;
        }
    }

    async function findClient() {
        const phone = document.getElementById('balance-phone').value;
        const data = await apiCall('/api/clients/by-phone/' + encodeURIComponent(phone));

        if (data) {
            document.getElementById('balance-display').style.display = 'block';
            document.getElementById('balance-amount').innerText = data.bonusBalance;
            currentClient = data;
        }
    }

    async function loadBonusHistory() {
        const phone = document.getElementById('history-phone').value;
        const client = await apiCall('/api/clients/by-phone/' + encodeURIComponent(phone));

        if (client && client.id) {
            const history = await apiCall('/api/clients/' + client.id + '/bonus-history');

            if (history && Array.isArray(history)) {
                let html = '<table class="data-table">';
                html += '<tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–ü—Ä–∏—á–∏–Ω–∞</th></tr>';

                history.forEach(txn => {
                    const date = new Date(txn.createdAt).toLocaleString();
                    html += `<tr>
                            <td>${date}</td>
                            <td><span class="badge ${txn.txnType === 'EARN' ? 'success' : 'danger'}">${txn.txnType}</span></td>
                            <td>${txn.signedAmount}</td>
                            <td>${txn.reason || ''}</td>
                        </tr>`;
                });

                html += '</table>';
                document.getElementById('history-table').innerHTML = html;
            }
        }
    }

    // ========== –ë–ê–†–ò–°–¢–ê ==========
    async function loadProductsForBarista() {
        products = await apiCall('/api/menu/products') || [];
        displayProducts(products);
    }

    function displayProducts(productsToShow) {
        let html = '';
        productsToShow.forEach(p => {
            if (p.active) {
                html += `
                        <div class="product-tile" onclick="selectProduct(${p.id}, '${p.name}', ${p.price})">
                            <div class="product-name">${p.name}</div>
                            <div class="product-price">${p.price}‚ÇΩ</div>
                            <div class="product-desc">${p.description || ''}</div>
                        </div>
                    `;
            }
        });
        document.getElementById('products-grid').innerHTML = html || '<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</p>';
    }

    function filterProducts(category) {
        document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
        event.target.classList.add('active');

        if (category === 'all') {
            displayProducts(products);
        } else {
            const filtered = products.filter(p => p.category && p.category.name === category);
            displayProducts(filtered);
        }
    }

    let selectedProduct = null;
    function selectProduct(id, name, price) {
        selectedProduct = { id, name, price };
        document.querySelectorAll('.product-tile').forEach(t => t.classList.remove('selected'));
        event.target.classList.add('selected');
    }

    function showAddItemModal() {
        if (!currentOrderId) {
            alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑!');
            return;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –≤ select
        let options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>';
        products.forEach(p => {
            if (p.active) {
                options += `<option value="${p.id}">${p.name} - ${p.price}‚ÇΩ</option>`;
            }
        });
        document.getElementById('add-product-select').innerHTML = options;

        document.getElementById('add-item-modal').style.display = 'block';
    }

    function hideAddItemModal() {
        document.getElementById('add-item-modal').style.display = 'none';
    }

    async function addItemToOrder() {
        const productId = document.getElementById('add-product-select').value;
        const qty = parseInt(document.getElementById('add-product-qty').value);

        if (!productId) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä');
            return;
        }

        const data = await apiCall('/api/orders/' + currentOrderId + '/items', 'POST', {
            productId: parseInt(productId),
            qty: qty
        });

        if (data) {
            currentOrder = data;
            updateOrderDisplay();
            hideAddItemModal();
        }
    }

    async function createNewOrder() {
        const data = await apiCall('/api/orders', 'POST', {
            createdByUserId: 1,
            phone: currentClient ? currentClient.phone : null
        });

        if (data) {
            currentOrderId = data.id;
            currentOrder = data;
            document.getElementById('current-order-id').value = data.id;
            updateOrderDisplay();
        }
    }

    async function loadOrderItems() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º API –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π –∑–∞–∫–∞–∑–∞
        // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ currentOrder
        if (currentOrder) {
            updateOrderDisplay();
        }
    }

    function updateOrderDisplay() {
        if (!currentOrder) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ
        if (currentClient) {
            document.getElementById('order-client').innerHTML =
                `${currentClient.fullName} (${currentClient.phone})`;
            document.getElementById('order-client-balance').innerHTML =
                `–ë–∞–ª–∞–Ω—Å: <strong>${currentClient.bonusBalance}</strong> –±–æ–Ω—É—Å–æ–≤`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É
        document.getElementById('cart-subtotal').innerHTML = currentOrder.subtotal + '‚ÇΩ';

        const limit = Math.round(currentOrder.subtotal * 0.3);
        document.getElementById('bonus-limit').innerHTML = limit + '‚ÇΩ';

        const bonusInput = document.getElementById('bonus-to-spend');
        bonusInput.max = Math.min(limit, currentClient?.bonusBalance || 0);

        const total = currentOrder.total || currentOrder.subtotal;
        document.getElementById('cart-total').innerHTML = total + '‚ÇΩ';

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞
        loadOrderItemsFromServer();
    }

    async function loadOrderItemsFromServer() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º API –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è items
        // –ü–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        const items = await apiCall('/api/orders/' + currentOrderId + '/items');
        if (items && Array.isArray(items)) {
            let html = '';
            items.forEach(item => {
                html += `
                        <div class="cart-item">
                            <span>${item.productNameSnap} x${item.qty}</span>
                            <span>${item.lineTotal}‚ÇΩ</span>
                        </div>
                    `;
            });
            document.getElementById('mini-cart').innerHTML = html || '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
        }
    }

    async function spendBonuses() {
        if (!currentOrderId) {
            alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞');
            return;
        }

        const amount = document.getElementById('bonus-to-spend').value;

        const data = await apiCall('/api/orders/' + currentOrderId + '/spend-bonus', 'POST', {
            amount: parseFloat(amount)
        });

        if (data) {
            currentOrder = data;
            updateOrderDisplay();

            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∫–ª–∏–µ–Ω—Ç–∞
            if (currentClient) {
                const client = await apiCall('/api/clients/by-phone/' + encodeURIComponent(currentClient.phone));
                if (client) {
                    currentClient = client;
                    document.getElementById('order-client-balance').innerHTML =
                        `–ë–∞–ª–∞–Ω—Å: <strong>${client.bonusBalance}</strong> –±–æ–Ω—É—Å–æ–≤`;
                }
            }
        }
    }

    async function completeOrder() {
        if (!currentOrderId) {
            alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞');
            return;
        }

        const data = await apiCall('/api/orders/' + currentOrderId + '/complete', 'POST');

        if (data) {
            currentOrder = data;
            alert('–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! –ù–∞—á–∏—Å–ª–µ–Ω –∫—ç—à–±—ç–∫ 5%');
            updateOrderDisplay();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑
            currentOrderId = null;
            currentOrder = null;
            document.getElementById('current-order-id').value = '';
            document.getElementById('mini-cart').innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
        }
    }

    function showClientSearch() {
        document.getElementById('client-search-modal').style.display = 'block';
    }

    function hideClientSearch() {
        document.getElementById('client-search-modal').style.display = 'none';
    }

    async function searchClient() {
        const phone = document.getElementById('search-phone').value;
        const data = await apiCall('/api/clients/by-phone/' + encodeURIComponent(phone));

        if (data) {
            currentClient = data;
            document.getElementById('order-client').innerHTML =
                `${data.fullName} (${data.phone})`;
            document.getElementById('order-client-balance').innerHTML =
                `–ë–∞–ª–∞–Ω—Å: <strong>${data.bonusBalance}</strong> –±–æ–Ω—É—Å–æ–≤`;
            hideClientSearch();

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Å –Ω–æ–≤—ã–º –∫–ª–∏–µ–Ω—Ç–æ–º
            if (currentOrderId) {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º API –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∫ –∑–∞–∫–∞–∑—É
            }
        }
    }

    async function registerNewClient() {
        const phone = document.getElementById('search-phone').value;
        const name = prompt('–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:', '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç');

        if (!name) return;

        const data = await apiCall('/api/clients/register', 'POST', {
            phone: phone,
            fullName: name
        });

        if (data) {
            alert('–ö–ª–∏–µ–Ω—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω! +50 –±–æ–Ω—É—Å–æ–≤');
            searchClient(); // –û–±–Ω–æ–≤–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        }
    }

    // ========== –ê–î–ú–ò–ù ==========
    async function loadAdminProducts() {
        const data = await apiCall('/api/menu/products');

        if (data && Array.isArray(data)) {
            let html = '';
            data.forEach(p => {
                html += `<tr>
                        <td>${p.id}</td>
                        <td>${p.category?.name || '-'}</td>
                        <td>${p.name}</td>
                        <td>${p.price}‚ÇΩ</td>
                        <td><span class="badge ${p.active ? 'success' : 'danger'}">${p.active ? '–î–∞' : '–ù–µ—Ç'}</span></td>
                    </tr>`;
            });
            document.getElementById('products-table-body').innerHTML = html;
        }
    }

    function filterAdminProducts() {
        const category = document.getElementById('admin-category-filter').value;
        if (category === 'all') {
            loadAdminProducts();
        } else {
            apiCall('/api/menu/products?category=' + encodeURIComponent(category))
                .then(data => {
                    if (data && Array.isArray(data)) {
                        let html = '';
                        data.forEach(p => {
                            html += `<tr>
                                    <td>${p.id}</td>
                                    <td>${p.category?.name || '-'}</td>
                                    <td>${p.name}</td>
                                    <td>${p.price}‚ÇΩ</td>
                                    <td><span class="badge ${p.active ? 'success' : 'danger'}">${p.active ? '–î–∞' : '–ù–µ—Ç'}</span></td>
                                </tr>`;
                        });
                        document.getElementById('products-table-body').innerHTML = html;
                    }
                });
        }
    }

    async function loadAllOrders() {
        const data = await apiCall('/api/orders/all');

        if (data && Array.isArray(data)) {
            let html = '';
            data.forEach(o => {
                const date = new Date(o.createdAt).toLocaleDateString();
                html += `<tr>
                        <td>${o.id}</td>
                        <td>${date}</td>
                        <td>${o.clientId || '–ù–µ—Ç'}</td>
                        <td>${o.total}‚ÇΩ</td>
                        <td><span class="badge ${o.status === 'COMPLETED' ? 'success' : 'warning'}">${o.status}</span></td>
                    </tr>`;
            });
            document.getElementById('orders-table-body').innerHTML = html;
        }
    }

    async function loadAllClients() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º API –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ getAllClients
        // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∏—Å–∫ –ø–æ —Ç–µ—Å—Ç–æ–≤–æ–º—É –Ω–æ–º–µ—Ä—É
        const client = await apiCall('/api/clients/by-phone/+79991112233');

        if (client) {
            let html = '<table class="data-table">';
            html += '<tr><th>ID</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ò–º—è</th><th>–ë–∞–ª–∞–Ω—Å</th></tr>';
            html += `<tr>
                    <td>${client.id}</td>
                    <td>${client.phone}</td>
                    <td>${client.fullName || '-'}</td>
                    <td><strong>${client.bonusBalance}</strong></td>
                </tr>`;
            html += '</table>';
            document.getElementById('clients-list').innerHTML = html;
        }
    }

    async function loadAdminStats() {
        // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        const orders = await apiCall('/api/orders/all') || [];
        const products = await apiCall('/api/menu/products') || [];

        const completedOrders = orders.filter(o => o.status === 'COMPLETED');
        const totalRevenue = completedOrders.reduce((sum, o) => sum + (o.total || 0), 0);
        const totalBonuses = completedOrders.reduce((sum, o) => sum + (o.bonusSpent || 0), 0);

        const statsHtml = `
                <div class="totals-row">
                    <span>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤:</span>
                    <span>${orders.length}</span>
                </div>
                <div class="totals-row">
                    <span>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤:</span>
                    <span>${completedOrders.length}</span>
                </div>
                <div class="totals-row">
                    <span>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞:</span>
                    <span>${totalRevenue}‚ÇΩ</span>
                </div>
                <div class="totals-row">
                    <span>–í—Å–µ–≥–æ —Å–ø–∏—Å–∞–Ω–æ –±–æ–Ω—É—Å–æ–≤:</span>
                    <span>${totalBonuses}</span>
                </div>
                <div class="totals-row">
                    <span>–¢–æ–≤–∞—Ä–æ–≤ –≤ –º–µ–Ω—é:</span>
                    <span>${products.length}</span>
                </div>
            `;

        document.getElementById('stats-display').innerHTML = statsHtml;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = function() {
        loadProductsForBarista();
    };
</script>
</body>
</html>